<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品借用系統</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn-action {
            margin: 5px;
        }
        .status-badge {
            font-size: 0.85em;
        }
        .item-card {
            transition: transform 0.2s;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 導航欄 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#" @click="goToHome">
                    <i class="bi bi-box-seam"></i> 物品借用系統
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto" v-if="isLoggedIn">
                        <li class="nav-item">
                            <a class="nav-link" href="#" @click="currentView = 'home'">
                                <i class="bi bi-house"></i> 首頁
                            </a>
                        </li>
                        <li class="nav-item" v-if="userRole === 'member'">
                            <a class="nav-link" href="#" @click="currentView = 'myItems'">
                                <i class="bi bi-box"></i> 我的物品
                            </a>
                        </li>
                        <li class="nav-item" v-if="userRole === 'member'">
                            <a class="nav-link" href="#" @click="currentView = 'browseItems'">
                                <i class="bi bi-search"></i> 瀏覽物品
                            </a>
                        </li>
                        <li class="nav-item" v-if="userRole === 'member'">
                            <a class="nav-link" href="#" @click="currentView = 'myRecords'">
                                <i class="bi bi-list-ul"></i> 個人紀錄
                            </a>
                        </li>
                        <li class="nav-item" v-if="userRole === 'member'">
                            <a class="nav-link" href="#" @click="currentView = 'ownerReservations'">
                                <i class="bi bi-calendar-check"></i> 我的借出物品
                            </a>
                        </li>
                        <li class="nav-item" v-if="userRole === 'staff'">
                            <a class="nav-link" href="#" @click="currentView = 'staffVerification'">
                                <i class="bi bi-check-circle"></i> 審核物品
                            </a>
                        </li>
                        <li class="nav-item" v-if="userRole === 'staff'">
                            <a class="nav-link" href="#" @click="currentView = 'staffReports'">
                                <i class="bi bi-flag"></i> 處理檢舉
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" @click="showProfile">
                                <i class="bi bi-person"></i> {{ userName }}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" @click="logout">
                                <i class="bi bi-box-arrow-right"></i> 登出
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- 主要內容區域 -->
        <div class="container mt-4">
            <!-- 未登入時顯示登入/註冊頁面 -->
            <div v-if="!isLoggedIn">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs">
                                    <li class="nav-item">
                                        <a class="nav-link" :class="{active: showLogin}" @click="showLogin = true" href="#">登入</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" :class="{active: !showLogin}" @click="showLogin = false" href="#">註冊</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <!-- 登入表單 -->
                                <div v-if="showLogin">
                                    <h5 class="card-title">登入</h5>
                                    <form @submit.prevent="handleLogin">
                                        <div class="mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" v-model="loginForm.email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">密碼</label>
                                            <input type="password" class="form-control" v-model="loginForm.password" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">登入身份</label>
                                            <select class="form-select" v-model="loginForm.login_as">
                                                <option value="member">會員</option>
                                                <option value="staff">員工</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">登入</button>
                                    </form>
                                </div>
                                <!-- 註冊表單 -->
                                <div v-else>
                                    <h5 class="card-title">註冊</h5>
                                    <form @submit.prevent="handleRegister">
                                        <div class="mb-3">
                                            <label class="form-label">姓名</label>
                                            <input type="text" class="form-control" v-model="registerForm.name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Email (必須是 @ntu.edu.tw)</label>
                                            <input type="email" class="form-control" v-model="registerForm.email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">密碼</label>
                                            <input type="password" class="form-control" v-model="registerForm.password" required>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">註冊</button>
                                    </form>
                                </div>
                                <div v-if="errorMessage" class="alert alert-danger mt-3">
                                    {{ errorMessage }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 已登入後顯示的內容 -->
            <div v-else>
                <!-- 首頁 -->
                <div v-if="currentView === 'home'">
                    <h2>歡迎，{{ userName }}！</h2>
                    <div class="row">
                        <div class="col-md-4" v-if="userRole === 'member'">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-box fs-1 text-primary"></i>
                                    <h5 class="card-title mt-3">我的物品</h5>
                                    <p class="card-text">管理您上架的物品</p>
                                    <button class="btn btn-primary" @click="currentView = 'myItems'">前往</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" v-if="userRole === 'member'">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-search fs-1 text-success"></i>
                                    <h5 class="card-title mt-3">瀏覽物品</h5>
                                    <p class="card-text">尋找並預約物品</p>
                                    <button class="btn btn-success" @click="currentView = 'browseItems'">前往</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" v-if="userRole === 'member'">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-list-ul fs-1 text-info"></i>
                                    <h5 class="card-title mt-3">個人紀錄</h5>
                                    <p class="card-text">查看預約和評論</p>
                                    <button class="btn btn-info" @click="currentView = 'myRecords'">前往</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" v-if="userRole === 'member'">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-calendar-check fs-1 text-secondary"></i>
                                    <h5 class="card-title mt-3">我的借出物品</h5>
                                    <p class="card-text">管理借出物品，進行打卡</p>
                                    <button class="btn btn-secondary" @click="currentView = 'ownerReservations'">前往</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" v-if="userRole === 'staff'">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-check-circle fs-1 text-warning"></i>
                                    <h5 class="card-title mt-3">審核物品</h5>
                                    <p class="card-text">處理物品驗證</p>
                                    <button class="btn btn-warning" @click="currentView = 'staffVerification'">前往</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" v-if="userRole === 'staff'">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-flag fs-1 text-danger"></i>
                                    <h5 class="card-title mt-3">處理檢舉</h5>
                                    <p class="card-text">處理檢舉案件</p>
                                    <button class="btn btn-danger" @click="currentView = 'staffReports'">前往</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 我的物品 (Member) -->
                <div v-if="currentView === 'myItems' && userRole === 'member'">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>我的物品</h2>
                        <button class="btn btn-primary" @click="showUploadModal = true">
                            <i class="bi bi-plus-circle"></i> 上傳新物品
                        </button>
                    </div>
                    <div v-if="loading" class="text-center">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div v-else class="row">
                        <div class="col-md-6 col-lg-4" v-for="item in myItems" :key="item.i_id">
                            <div class="card item-card">
                                <div class="card-body">
                                    <h5 class="card-title">{{ item.i_name }}</h5>
                                    <p class="card-text">{{ item.description }}</p>
                                    <p class="card-text">
                                        <span class="badge" :class="getStatusBadgeClass(item.status)">{{ item.status }}</span>
                                    </p>
                                    <p class="card-text"><small class="text-muted">最大單次外借時長: {{ formatDuration(item.out_duration) }}</small></p>
                                    <div class="btn-group w-100">
                                        <button class="btn btn-sm btn-outline-primary" @click="editItem(item)">編輯</button>
                                        <button class="btn btn-sm btn-outline-warning" @click="verifyItem(item.i_id)" v-if="item.status === 'Not verified'">申請審核</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="removeItem(item)" v-if="item.status !== 'Not reservable'">下架</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 瀏覽物品 (Member) -->
                <div v-if="currentView === 'browseItems' && userRole === 'member'" @click.self="browseCategorySelector.showDropdown = false">
                    <h2>瀏覽物品</h2>
                    <div class="mb-3">
                        <label class="form-label">選擇類別</label>
                        <div class="position-relative" @click.stop>
                            <input 
                                type="text" 
                                class="form-control" 
                                :value="browseCategorySelector.displayText || '點擊選擇類別（可選）'" 
                                @click="onBrowseCategoryFieldClick"
                                @focus="onBrowseCategoryFieldClick"
                                readonly
                                placeholder="點擊選擇類別（可選）"
                            >
                            <div 
                                v-if="browseCategorySelector.showDropdown" 
                                class="dropdown-menu show position-absolute w-100" 
                                style="z-index: 1050; max-height: 300px; overflow-y: auto; top: 100%;"
                                @click.stop
                            >
                                <div v-if="browseCategorySelector.currentSubcategories.length === 0 && browseCategorySelector.selectedPath.length === 0" class="dropdown-item text-muted">
                                    載入中...
                                </div>
                                <a 
                                    v-for="cat in browseCategorySelector.currentSubcategories" 
                                    :key="cat.c_id"
                                    class="dropdown-item" 
                                    href="#" 
                                    @click.prevent="selectBrowseCategory(cat)"
                                >
                                    {{ cat.c_name }}
                                </a>
                                <div class="dropdown-divider" v-if="browseCategorySelector.selectedPath.length > 0"></div>
                                <a 
                                    class="dropdown-item text-muted" 
                                    href="#" 
                                    @click.prevent="finishBrowseCategorySelection"
                                    v-if="browseCategorySelector.selectedPath.length > 0"
                                >
                                    完成選擇（使用當前類別）
                                </a>
                                <div class="dropdown-divider" v-if="browseCategorySelector.selectedPath.length > 0"></div>
                                <a 
                                    class="dropdown-item text-danger" 
                                    href="#" 
                                    @click.prevent="clearBrowseCategory"
                                >
                                    清除選擇（顯示全部）
                                </a>
                            </div>
                        </div>
                        <small class="form-text text-muted">選擇類別後，可以繼續選擇子類別，或點擊「完成選擇」結束。點擊「清除選擇」可顯示全部物品。</small>
                    </div>
                    <div v-if="loading" class="text-center">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div v-else class="row">
                        <div class="col-md-6 col-lg-4" v-for="item in browseItems" :key="item.i_id">
                            <div class="card item-card">
                                <div class="card-body">
                                    <h5 class="card-title">{{ item.i_name }}</h5>
                                    <p class="card-text">{{ item.description }}</p>
                                    <p class="card-text">
                                        <span class="badge" :class="getStatusBadgeClass(item.status)">{{ item.status }}</span>
                                    </p>
                                    <p class="card-text"><small class="text-muted">最大單次外借時長: {{ formatDuration(item.out_duration) }}</small></p>
                                    <div class="btn-group w-100">
                                        <button class="btn btn-sm btn-primary" @click="viewItemDetail(item.i_id)">查看詳情</button>
                                        <button class="btn btn-sm btn-success" @click="addToWishlist(item)" v-if="item.status === 'Reservable'">加入待借清單</button>
                                        <button class="btn btn-sm btn-danger" @click="reportItem(item.i_id)">檢舉</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 個人紀錄 (Member) -->
                <div v-if="currentView === 'myRecords' && userRole === 'member'">
                    <h2>個人紀錄</h2>
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link" :class="{active: recordsTab === 'reservations'}" @click="recordsTab = 'reservations'" href="#">預約紀錄</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{active: recordsTab === 'reviews'}" @click="recordsTab = 'reviews'" href="#">評論</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{active: recordsTab === 'contributions'}" @click="recordsTab = 'contributions'" href="#">貢獻紀錄</a>
                        </li>
                    </ul>
                    <div class="mt-3">
                        <!-- 預約紀錄 -->
                        <div v-if="recordsTab === 'reservations'">
                            <div v-if="loading" class="text-center">
                                <div class="spinner-border" role="status"></div>
                            </div>
                            <div v-else>
                                <div class="card" v-for="reservation in myReservations" :key="reservation.r_id">
                                    <div class="card-body">
                                        <h5 class="card-title">預約 #{{ reservation.r_id }}</h5>
                                        <p class="card-text">建立時間: {{ formatDate(reservation.create_at) }}</p>
                                        <p class="card-text">物品: {{ reservation.items.join(', ') }}</p>
                                        <button class="btn btn-sm btn-primary" @click="viewReservationDetail(reservation.r_id)">查看詳情</button>
                                        <button class="btn btn-sm btn-danger" @click="cancelReservation(reservation.r_id)">取消預約</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 評論 -->
                        <div v-if="recordsTab === 'reviews'">
                            <div v-if="loading" class="text-center">
                                <div class="spinner-border" role="status"></div>
                            </div>
                            <div v-else>
                                <div class="card" v-for="item in reviewableItems" :key="item.l_id">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ item.i_name }}</h5>
                                        <p class="card-text">評論對象: {{ item.object_name }} ({{ item.review_target === 'owner' ? '物主' : '借用人' }})</p>
                                        <p class="card-text">歸還時間: {{ formatDate(item.actual_return_at) }}</p>
                                        <button class="btn btn-sm btn-primary" @click="showReviewModal(item)">撰寫評論</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 貢獻紀錄 -->
                        <div v-if="recordsTab === 'contributions'">
                            <div v-if="loading" class="text-center">
                                <div class="spinner-border" role="status"></div>
                            </div>
                            <div v-else>
                                <h4>我的貢獻</h4>
                                <div class="card" v-for="contribution in contributions" :key="contribution.i_id">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ contribution.i_name }}</h5>
                                        <p class="card-text">類別: {{ contribution.c_name }}</p>
                                        <span class="badge" :class="contribution.is_active ? 'bg-success' : 'bg-secondary'">
                                            {{ contribution.is_active ? '啟用' : '停用' }}
                                        </span>
                                    </div>
                                </div>
                                <h4 class="mt-4">被封鎖的類別</h4>
                                <div class="card" v-for="ban in bans" :key="ban.c_id">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ ban.c_name }}</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 員工審核頁面 -->
                <div v-if="currentView === 'staffVerification' && userRole === 'staff'">
                    <h2>待審核物品</h2>
                    <div v-if="loading" class="text-center">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div v-else>
                        <div class="card" v-for="verification in verifications" :key="verification.iv_id">
                            <div class="card-body">
                                <h5 class="card-title">驗證 ID: {{ verification.iv_id }}</h5>
                                <p class="card-text">物品 ID: {{ verification.i_id }}</p>
                                <p class="card-text">建立時間: {{ formatDate(verification.create_at) }}</p>
                                <button class="btn btn-success" @click="concludeVerification(verification.iv_id, 'Pass')">通過</button>
                                <button class="btn btn-danger" @click="concludeVerification(verification.iv_id, 'Fail')">不通過</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 員工檢舉處理頁面 -->
                <div v-if="currentView === 'staffReports' && userRole === 'staff'">
                    <h2>待處理檢舉</h2>
                    <div v-if="loading" class="text-center">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div v-else>
                        <div class="card" v-for="report in reports" :key="report.re_id">
                            <div class="card-body">
                                <h5 class="card-title">檢舉 ID: {{ report.re_id }}</h5>
                                <p class="card-text">檢舉內容: {{ report.comment }}</p>
                                <p class="card-text">建立時間: {{ formatDate(report.create_at) }}</p>
                                <p class="card-text">物品 ID: {{ report.i_id }}</p>
                                <div class="btn-group">
                                    <button class="btn btn-secondary" @click="concludeReport(report.re_id, 'Withdraw')">撤回</button>
                                    <button class="btn btn-warning" @click="concludeReport(report.re_id, 'Ban Category')">封鎖類別</button>
                                    <button class="btn btn-danger" @click="concludeReport(report.re_id, 'Delist')">下架</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 物主的借出物品頁面 -->
                <div v-if="currentView === 'ownerReservations' && userRole === 'member'">
                    <h2>我的借出物品</h2>
                    <p class="text-muted">管理您借出的物品，進行交貨和歸還的打卡操作</p>
                    <div v-if="loading" class="text-center">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div v-else-if="ownerReservations.length === 0" class="alert alert-info">
                        目前沒有需要處理的借出物品
                    </div>
                    <div v-else class="row">
                        <div class="col-md-6 col-lg-4" v-for="reservation in ownerReservations" :key="reservation.l_id">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Loan ID: {{ reservation.l_id }}</h5>
                                    <p class="card-text"><strong>物品 ID:</strong> {{ reservation.i_id }}</p>
                                    <p class="card-text"><strong>借用人:</strong> {{ reservation.m_name }}</p>
                                    <p class="card-text">
                                        <strong>預計開始:</strong> {{ formatDateTime(reservation.est_start_at) }}
                                    </p>
                                    <p class="card-text">
                                        <strong>預計歸還:</strong> {{ formatDateTime(reservation.est_due_at) }}
                                    </p>
                                    <div class="btn-group w-100" role="group">
                                        <button 
                                            class="btn btn-success" 
                                            @click="handlePunchIn(reservation.l_id, 'Handover')"
                                        >
                                            <i class="bi bi-check-circle"></i> 交貨打卡
                                        </button>
                                        <button 
                                            class="btn btn-primary" 
                                            @click="handlePunchIn(reservation.l_id, 'Return')"
                                        >
                                            <i class="bi bi-arrow-return-left"></i> 歸還打卡
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上傳物品 Modal -->
        <div class="modal fade" :class="{show: showUploadModal}" :style="{display: showUploadModal ? 'block' : 'none'}" tabindex="-1" @click.self="categorySelector.showDropdown = false" @click.stop>
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">上傳新物品</h5>
                        <button type="button" class="btn-close" @click="showUploadModal = false; resetUploadForm()"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="handleUploadItem">
                            <div class="mb-3">
                                <label class="form-label">物品名稱</label>
                                <input type="text" class="form-control" v-model="uploadForm.i_name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" v-model="uploadForm.description" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">最大單次外借時長</label>
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <label class="form-label small">年</label>
                                        <input type="number" class="form-control" v-model.number="uploadForm.out_duration.years" min="0" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">月</label>
                                        <input type="number" class="form-control" v-model.number="uploadForm.out_duration.months" min="0" max="11" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">天</label>
                                        <input type="number" class="form-control" v-model.number="uploadForm.out_duration.days" min="0" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">小時</label>
                                        <input type="number" class="form-control" v-model.number="uploadForm.out_duration.hours" min="0" max="23" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">分鐘</label>
                                        <input type="number" class="form-control" v-model.number="uploadForm.out_duration.minutes" min="0" max="59" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">秒</label>
                                        <input type="number" class="form-control" v-model.number="uploadForm.out_duration.seconds" min="0" max="59" placeholder="0">
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    總時長：{{ formatDuration(convertToSeconds(uploadForm.out_duration)) }}
                                </small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">類別</label>
                                <div class="position-relative" @click.stop>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        :value="categorySelector.displayText || '點擊選擇類別'" 
                                        @click="onCategoryFieldClick(true, $event)"
                                        @focus="onCategoryFieldClick(true, $event)"
                                        readonly
                                        required
                                        placeholder="點擊選擇類別"
                                    >
                                    <div 
                                        v-if="categorySelector.showDropdown && categorySelector.isUploadForm" 
                                        class="dropdown-menu show position-absolute w-100" 
                                        style="z-index: 1050; max-height: 300px; overflow-y: auto; top: 100%;"
                                        @click.stop
                                    >
                                        <div v-if="categorySelector.currentSubcategories.length === 0 && categorySelector.selectedPath.length === 0" class="dropdown-item text-muted">
                                            載入中...
                                        </div>
                                        <a 
                                            v-for="cat in categorySelector.currentSubcategories" 
                                            :key="cat.c_id"
                                            class="dropdown-item" 
                                            href="#" 
                                            @click.prevent="selectCategory(cat)"
                                        >
                                            {{ cat.c_name }}
                                        </a>
                                        <div class="dropdown-divider" v-if="categorySelector.selectedPath.length > 0"></div>
                                        <a 
                                            class="dropdown-item text-muted" 
                                            href="#" 
                                            @click.prevent="finishCategorySelection"
                                            v-if="categorySelector.selectedPath.length > 0"
                                        >
                                            完成選擇（使用當前類別）
                                        </a>
                                    </div>
                                </div>
                                <small class="form-text text-muted">選擇類別後，可以繼續選擇子類別，或點擊「完成選擇」結束</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">取貨地點</label>
                                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    <div v-if="allPickupPlaces.length === 0" class="text-muted">
                                        載入中...
                                    </div>
                                    <div v-else>
                                        <div 
                                            v-for="place in allPickupPlaces" 
                                            :key="place.p_id"
                                            class="form-check"
                                        >
                                            <input 
                                                class="form-check-input" 
                                                type="checkbox" 
                                                :id="'upload-p-' + place.p_id"
                                                :checked="isPickupPlaceSelected(place.p_id)"
                                                @change="togglePickupPlace(place.p_id)"
                                            >
                                            <label class="form-check-label" :for="'upload-p-' + place.p_id">
                                                {{ place.p_name }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">上傳</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade" :class="{show: showUploadModal}" v-if="showUploadModal"></div>

        <!-- 編輯物品 Modal -->
        <div class="modal fade" :class="{show: showEditModal}" :style="{display: showEditModal ? 'block' : 'none'}" tabindex="-1" @click.self="categorySelector.showDropdown = false" @click.stop>
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">編輯物品</h5>
                        <button type="button" class="btn-close" @click="showEditModal = false; resetCategorySelector()"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="handleUpdateItem">
                            <div class="mb-3">
                                <label class="form-label">物品名稱</label>
                                <input type="text" class="form-control" v-model="editForm.i_name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" v-model="editForm.description"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">最大單次外借時長</label>
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <label class="form-label small">年</label>
                                        <input type="number" class="form-control" v-model.number="editForm.out_duration.years" min="0" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">月</label>
                                        <input type="number" class="form-control" v-model.number="editForm.out_duration.months" min="0" max="11" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">天</label>
                                        <input type="number" class="form-control" v-model.number="editForm.out_duration.days" min="0" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">小時</label>
                                        <input type="number" class="form-control" v-model.number="editForm.out_duration.hours" min="0" max="23" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">分鐘</label>
                                        <input type="number" class="form-control" v-model.number="editForm.out_duration.minutes" min="0" max="59" placeholder="0">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">秒</label>
                                        <input type="number" class="form-control" v-model.number="editForm.out_duration.seconds" min="0" max="59" placeholder="0">
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    總時長：{{ formatDuration(convertToSeconds(editForm.out_duration)) }}
                                </small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">類別</label>
                                <div class="position-relative" @click.stop>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        :value="categorySelector.displayText || '點擊選擇類別'" 
                                        @click="onCategoryFieldClick(false, $event)"
                                        @focus="onCategoryFieldClick(false, $event)"
                                        readonly
                                        placeholder="點擊選擇類別"
                                    >
                                    <div 
                                        v-if="categorySelector.showDropdown && !categorySelector.isUploadForm" 
                                        class="dropdown-menu show position-absolute w-100" 
                                        style="z-index: 1050; max-height: 300px; overflow-y: auto; top: 100%;"
                                        @click.stop
                                    >
                                        <div v-if="categorySelector.currentSubcategories.length === 0 && categorySelector.selectedPath.length === 0" class="dropdown-item text-muted">
                                            載入中...
                                        </div>
                                        <a 
                                            v-for="cat in categorySelector.currentSubcategories" 
                                            :key="cat.c_id"
                                            class="dropdown-item" 
                                            href="#" 
                                            @click.prevent="selectCategory(cat)"
                                        >
                                            {{ cat.c_name }}
                                        </a>
                                        <div class="dropdown-divider" v-if="categorySelector.selectedPath.length > 0"></div>
                                        <a 
                                            class="dropdown-item text-muted" 
                                            href="#" 
                                            @click.prevent="finishCategorySelection"
                                            v-if="categorySelector.selectedPath.length > 0"
                                        >
                                            完成選擇（使用當前類別）
                                        </a>
                                    </div>
                                </div>
                                <small class="form-text text-muted">選擇類別後，可以繼續選擇子類別，或點擊「完成選擇」結束</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">取貨地點</label>
                                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    <div v-if="allPickupPlaces.length === 0" class="text-muted">
                                        載入中...
                                    </div>
                                    <div v-else>
                                        <div 
                                            v-for="place in allPickupPlaces" 
                                            :key="place.p_id"
                                            class="form-check"
                                        >
                                            <input 
                                                class="form-check-input" 
                                                type="checkbox" 
                                                :id="'edit-p-' + place.p_id"
                                                :checked="isPickupPlaceSelected(place.p_id)"
                                                @change="togglePickupPlace(place.p_id)"
                                            >
                                            <label class="form-check-label" :for="'edit-p-' + place.p_id">
                                                {{ place.p_name }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">更新</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade" :class="{show: showEditModal}" v-if="showEditModal"></div>

        <!-- 預約 Modal -->
        <div class="modal fade" :class="{show: showReservationModal}" :style="{display: showReservationModal ? 'block' : 'none'}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">建立預約</h5>
                        <button type="button" class="btn-close" @click="showReservationModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div v-for="(rd, index) in reservationForm.rd_list" :key="index" class="card mb-3">
                            <div class="card-body">
                                <h6>物品 #{{ index + 1 }}</h6>
                                <div class="mb-3" v-if="rd.i_name">
                                    <label class="form-label">物品名稱</label>
                                    <input type="text" class="form-control" :value="rd.i_name" readonly>
                                    <input type="hidden" v-model="rd.i_id">
                                </div>
                                <div class="mb-3" v-if="!rd.i_id">
                                    <label class="form-label">物品 ID</label>
                                    <input type="number" class="form-control" v-model="rd.i_id" @change="loadReservationItemData(index)" required>
                                    <small class="form-text text-muted">輸入物品 ID 後會自動載入取貨地點和已預約時段</small>
                                </div>
                                <div class="mb-3" v-if="rd.i_id && rd.pickup_places.length > 0">
                                    <label class="form-label">取貨地點</label>
                                    <select class="form-select" v-model="rd.p_id" required>
                                        <option value="">請選擇取貨地點</option>
                                        <option v-for="place in rd.pickup_places" :key="place.p_id" :value="place.p_id">
                                            {{ place.p_name }}
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3" v-if="rd.i_id && rd.pickup_places.length === 0">
                                    <label class="form-label">取貨地點</label>
                                    <div class="alert alert-info">載入中...</div>
                                </div>
                                <div class="mb-3" v-if="rd.i_id">
                                    <label class="form-label">已被預約的時段</label>
                                    <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto; background-color: #f8f9fa;">
                                        <div v-if="rd.borrowed_times && rd.borrowed_times.length > 0">
                                            <div v-for="(bt, btIndex) in rd.borrowed_times" :key="btIndex" class="mb-2 p-2 bg-light rounded">
                                                <small>
                                                    <strong>開始:</strong> {{ formatDateTime(bt.est_start_at) }}<br>
                                                    <strong>結束:</strong> {{ formatDateTime(bt.est_due_at) }}
                                                </small>
                                            </div>
                                        </div>
                                        <div v-else class="text-muted">
                                            目前沒有被預約的時段
                                        </div>
                                    </div>
                                    <small class="form-text text-muted" v-if="rd.borrowed_times && rd.borrowed_times.length > 0">請避免選擇與上述時段重疊的時間</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">預計開始時間</label>
                                    <input type="datetime-local" class="form-control" v-model="rd.est_start_at" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">預計歸還時間</label>
                                    <input type="datetime-local" class="form-control" v-model="rd.est_due_at" required>
                                </div>
                                <button class="btn btn-sm btn-danger" @click="removeReservationItem(index)" v-if="reservationForm.rd_list.length > 1">移除</button>
                            </div>
                        </div>
                        <button class="btn btn-primary" @click="handleCreateReservation">建立預約</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade" :class="{show: showReservationModal}" v-if="showReservationModal"></div>

        <!-- 評論 Modal -->
        <div class="modal fade" :class="{show: showReviewModalFlag}" :style="{display: showReviewModalFlag ? 'block' : 'none'}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">撰寫評論</h5>
                        <button type="button" class="btn-close" @click="showReviewModalFlag = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="handleReview">
                            <div class="mb-3">
                                <label class="form-label">評分 (1-5)</label>
                                <input type="number" class="form-control" v-model="reviewForm.score" min="1" max="5" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">評論內容</label>
                                <textarea class="form-control" v-model="reviewForm.comment" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">提交</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade" :class="{show: showReviewModalFlag}" v-if="showReviewModalFlag"></div>

        <!-- 成功/錯誤訊息提示 -->
        <div v-if="successMessage" class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999;">
            {{ successMessage }}
            <button type="button" class="btn-close" @click="successMessage = ''"></button>
        </div>
        <div v-if="errorMessage" class="alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; margin-top: 60px !important;">
            {{ errorMessage }}
            <button type="button" class="btn-close" @click="errorMessage = ''"></button>
        </div>
        
        <!-- 個人資料彈窗 -->
        <div class="modal fade show d-block" tabindex="-1" v-if="showProfileModal" style="background: rgba(0,0,0,0.4);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">個人資料</h5>
                        <button type="button" class="btn-close" @click="closeProfileModal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>姓名：</strong>{{ profileData.name }}</p>
                        <p><strong>Email：</strong>{{ profileData.email }}</p>
                        <p>
                            <strong>物主評分：</strong>
                            <span v-if="profileData.owner_rate !== null && profileData.owner_rate !== undefined && !isNaN(profileData.owner_rate)">
                                {{ Number(profileData.owner_rate).toFixed(2) }}
                            </span>
                            <span v-else>尚無評分</span>
                        </p>
                        <p>
                            <strong>借用人評分：</strong>
                            <span v-if="profileData.borrower_rate !== null && profileData.borrower_rate !== undefined && !isNaN(profileData.borrower_rate)">
                                {{ Number(profileData.borrower_rate).toFixed(2) }}
                            </span>
                            <span v-else>尚無評分</span>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="closeProfileModal">關閉</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 待借清單浮動按鈕 -->
        <div v-if="isLoggedIn && userRole === 'member'" class="position-fixed bottom-0 end-0 m-4" style="z-index: 1050;">
            <button 
                class="btn btn-primary btn-lg rounded-circle shadow-lg" 
                @click="showWishlist = !showWishlist"
                style="width: 60px; height: 60px;"
            >
                <i class="bi bi-cart"></i>
                <span v-if="wishlist.length > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ wishlist.length }}
                </span>
            </button>
        </div>
        
        <!-- 待借清單側邊欄 -->
        <div 
            v-if="showWishlist" 
            class="position-fixed top-0 end-0 h-100 bg-white shadow-lg" 
            style="width: 400px; z-index: 1040; overflow-y: auto;"
        >
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">待借清單 ({{ wishlist.length }})</h5>
                <button class="btn btn-sm btn-outline-secondary" @click="showWishlist = false">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="p-3">
                <div v-if="wishlist.length === 0" class="text-center text-muted py-5">
                    <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                    <p class="mt-3">待借清單是空的</p>
                    <p class="small">在瀏覽物品時點擊「加入待借清單」來添加物品</p>
                </div>
                <div v-else>
                    <div v-for="item in wishlist" :key="item.i_id" class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">{{ item.i_name }}</h6>
                            <p class="card-text small text-muted">{{ item.description }}</p>
                            <p class="card-text small">
                                <span class="badge" :class="getStatusBadgeClass(item.status)">{{ item.status }}</span>
                            </p>
                            <button class="btn btn-sm btn-danger w-100" @click="removeFromWishlist(item.i_id)">
                                <i class="bi bi-trash"></i> 移除
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" @click="createReservationFromWishlist()">
                        <i class="bi bi-check-circle"></i> 建立預約 ({{ wishlist.length }} 項)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 待借清單背景遮罩 -->
        <div 
            v-if="showWishlist" 
            class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" 
            style="z-index: 1035;"
            @click="showWishlist = false"
        ></div>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 應用程式主程式 -->
    <script src="app.js"></script>
</body>
</html>
